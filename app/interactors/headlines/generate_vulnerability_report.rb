module Headlines
  class GenerateVulnerabilityReport
    include Interactor

    def call
      context.report = {
        hsts: hsts_vulnerability,
        x_xss: x_xss_vulnerability,
        x_content_type: x_content_type_vulnerability,
        x_frame_options: x_frame_options_vulnerability,
        csp: csp_vulnerability
      }
    end

    private

    def same_domains
      Domain.all
    end

    def t_count(vulnerability)
      Scan
        .where(domain_id: same_domains.pluck(:id))
        .where("(not results ? :key) OR ((results -> :key)::int < 33)", key: vulnerability)
        .count
    end

    def hsts_vulnerability
      ((t_count("strict-transport-security").to_f / same_domains.count) * 100).round
    end

    def x_xss_vulnerability
      ((t_count("x-xss-protection").to_f / same_domains.count) * 100).round
    end

    def x_content_type_vulnerability
      ((t_count("x-content-type-options").to_f / same_domains.count) * 100).round
    end

    def x_frame_options_vulnerability
      ((t_count("x-frame-options").to_f / same_domains.count) * 100).round
    end

    def csp_vulnerability
      ((t_count("content-security-policy").to_f / same_domains.count) * 100).round
    end
  end
end
