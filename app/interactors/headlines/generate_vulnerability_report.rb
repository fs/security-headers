module Headlines
  class GenerateVulnerabilityReport
    include Interactor

    def call
      context.report = Hash[hash_report]
    end

    private

    def hash_report
      Headlines::SECURITY_HEADERS.map do |vulnerability|
        [vulnerability.gsub("-", "_"), send("#{vulnerability.gsub('-', '_')}_domains_percent")]
      end
    end

    def same_domains
      Domain
        .joins(:industries)
        .where("headlines_industries.id = ?", context.industry.id)
    end

    def domains_count_by(vulnerability)
      Scan
        .where(domain_id: same_domains.pluck(:id))
        .where("(not results ? :key) OR ((results -> :key)::int < 33)", key: vulnerability)
        .count
    end

    def domains_percent_by(vulnerability)
      ((domains_count_by(vulnerability).to_f / same_domains.count) * 100).round
    end

    Headlines::SECURITY_HEADERS.each do |vulnerability|
      define_method("#{vulnerability.gsub('-', '_')}_domains_percent") { domains_percent_by(vulnerability) }
    end
  end
end
