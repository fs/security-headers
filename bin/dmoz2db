#!/usr/bin/env sh

DMOZ_DIR=/tmp/dmoz2db
DMOZ_LIB=https://github.com/fs/dmoz2db
DMOZ_DBNAME=dmoz
DISCOURSE_DBNAME=discourse

if ! which pip > /dev/null; then
  wget https://bootstrap.pypa.io/get-pip.py -P /tmp
  python /tmp/get-pip.py
fi

sudo apt-get install libpq-dev python-dev
pip install sqlalchemy --upgrade
pip install psycopg2 --upgrade

if [ ! -f $DMOZ_DIR ]; then
  git clone -b update-conf https://github.com/fs/dmoz2db $DMOZ_DIR
fi

cd $DMOZ_DIR

wget http://rdf.dmoz.org/rdf/content.rdf.u8.gz -P src/
gunzip src/content.rdf.u8.gz

wget http://rdf.dmoz.org/rdf/structure.rdf.u8.gz -P src/
gunzip src/structure.rdf.u8.gz

su - postgres <<EOF
cd $DMOZ_DIR/src
createdb $DMOZ_DBNAME
python dmoz2db.py -s structure.rdf.u8 -c content.rdf.u8
psql $DMOZ_DBNAME < normalize.sql
EOF
echo 'Parse complete!'

sudo -u postgres -i pg_dump --table headlines_domains_categories --table headlines_categories --data-only dmoz > dmoz_categories.sql
echo 'Dump complete!'

su - discourse <<EOF
cd $DMOZ_DIR/src
psql $DISCOURSE_DBNAME < dmoz_categories.sql
EOF
echo 'Restore domplete!'

su - postgres -c "dropdb $DMOZ_DBNAME"
echo 'Dropped dmoz db'

rm structure.rdf.u8
rm content.rdf.u8
rm /tmp/get-pip.py
rm -rf $DMOZ_DIR

echo '---> Parse DMOZ data complete!'
exit 0
